<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
        // Load the Visualization API and the piechart package.
        google.load('visualization', '1.0', { 'packages': ['corechart'] });

        // Set a callback to run when the Google Visualization API is loaded.
        google.setOnLoadCallback(function () {
            makeChart('1h');
            makeChart('12h');
            makeChart('3d');
        });

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and
        // draws it.
        function makeChart(timeRange) {
            var public_key = '9Jbb3naY9ZFz2nWRo50g';

            var ldata = new google.visualization.DataTable();
            ldata.addColumn('datetime', 'Time');
            ldata.addColumn('number', '-Light sensor voltage');

            var tdata = new google.visualization.DataTable();
            tdata.addColumn('datetime', 'Time');
            tdata.addColumn('number', 'Temperature (C)');

            // JSONP request
            function fetchJSON(page_id) {
                $.ajax({
                    url: 'https://data.sparkfun.com/output/' + public_key + '.json',
                    data: { 'gt[timestamp]': 'now-' + timeRange },
                    dataType: 'jsonp',
                }).done(function (results) {
                    $.each(results, function (i, row) {
                        ldata.addRow([
                            (new Date(row.timestamp)),
                            -parseFloat(row.light)]);
                        tdata.addRow([
                            (new Date(row.timestamp)),
                            parseFloat(row.temp)
                        ]);
                    });

                    ldata.sort([{ column: 0 }]);
                    tdata.sort([{ column: 0 }]);

                    $("#loading_" + timeRange).hide();

                    var lchart = new google.visualization.LineChart($('#light_chart_' + timeRange).get(0));
                    lchart.draw(ldata, {
                        title: 'Light sensor (0 - light sensor voltage)'
                    });

                    var tchart = new google.visualization.LineChart($('#temp_chart_' + timeRange).get(0));
                    tchart.draw(tdata, {
                        title: 'Temperature sensor'
                    });
                }).error(function (jqXHR, textStatus) {
                    $("#errormsg_" + timeRange).text("Error downloading data: " + textStatus)
                });
            }

            fetchJSON(1);
        }


    </script>
</head>

<body>
    <h1>CC3501 data logger demo</h1>
    <p>
        Data is logged by a Freescale FRDM-K20D50M and a Raspberry Pi.
        Raw data is available <a href="https://data.sparkfun.com/streams/9Jbb3naY9ZFz2nWRo50g">here</a>.
    </p>

    <h2>Last hour</h2>
    <p id="loading_1h">Downloading data from data.sparkfun.com ... (this may take a while)</p>
    <p id="errormsg_1h"></p>
    <div id="light_chart_1h"></div>
    <div id="temp_chart_1h"></div>

    <h2>Last 12 hours</h2>
    <p id="loading_12h">Downloading data from data.sparkfun.com ... (this may take a while)</p>
    <p id="errormsg_12h"></p>
    <div id="light_chart_12h"></div>
    <div id="temp_chart_12h"></div>

    <h2>Last 3 days</h2>
    <p id="loading_3d">Downloading data from data.sparkfun.com ... (this may take a while)</p>
    <p id="errormsg_3d"></p>
    <div id="light_chart_3d"></div>
    <div id="temp_chart_3d"></div>
</body>
</html>
